<?php


global $registredSubdomains;

$registredSubdomains = array(
               'admin.cucak.am' =>   1  , 'www.admin.cucak.am'          =>   1
    ,          'artur.cucak.am' =>  22  , 'www.artur.cucak.am'          =>  22
    ,           'sona.cucak.am' =>  30  , 'www.sona.cucak.am'           =>  30
    ,       'andranik.cucak.am' =>  37  , 'www.andranik.cucak.am'       =>  37
    ,     'laptopshop.cucak.am' =>  58  , 'www.laptopshop.cucak.am'     =>  58
    ,    'ttcomputers.cucak.am' =>  75  , 'www.ttcomputers.cucak.am'    =>  75
    ,      'mysuccess.cucak.am' =>  87  , 'www.mysuccess.cucak.am'      =>  87
    ,          'nelly.cucak.am' => 101  , 'www.nelly.cucak.am'          => 101
    ,        'proline.cucak.am' => 106  , 'www.proline.cucak.am'        => 106
    ,            'jin.cucak.am' => 118  , 'www.jin.cucak.am'            => 118
    ,          'melan.cucak.am' => 124  , 'www.melan.cucak.am'          => 124
    , 'notebookcentre.cucak.am' => 130  , 'www.notebookcentre.cucak.am' => 130  , 'notebookcentre.am' => 130, 'www.notebookcentre.am' => 130
    ,         'armspy.cucak.am' => 127  , 'www.armspy.cucak.am'         => 127
    ,       'uslaptop.cucak.am' => 128  , 'www.uslaptop.cucak.am'       => 128
    ,     'luxurycode.cucak.am' => 150  , 'www.luxurycode.cucak.am'     => 150
    ,       'realtime.cucak.am' => 163  , 'www.realtime.cucak.am'       => 163
    ,         'mgcomp.cucak.am' => 168  , 'www.mgcomp.cucak.am'         => 168
    ,        'anymode.cucak.am' => 202  , 'www.anymode.cucak.am'        => 202
    ,         'fanfan.cucak.am' => 215  , 'www.fanfan.cucak.am'         => 215
    ,        'noberty.cucak.am' => 221  , 'www.noberty.cucak.am'        => 221
    ,         'gevorg.cucak.am' => 243  , 'www.gevorg.cucak.am'         => 243
    ,            'led.cucak.am' => 263  , 'www.led.cucak.am'            => 263
    ,            'aba.cucak.am' => 343  , 'www.aba.cucak.am'            => 343
    ,          'smart.cucak.am' => 349  , 'www.smart.cucak.am'          => 349
    ,       'codecomp.cucak.am' => 919  , 'www.codecomp.cucak.am'       => 919
);

global $additionalData;

$additionalData = array(
       22 => array('car3', 'Artur Manucharyan', 'Cars', '//artur.cucak.am/', '#25a6b7', 'white', 22)
    ,  37 => array('camera', 'Andranik Hambardzumyan', 'Photo / Video cameras', '//andranik.cucak.am/', '#654987', 'white', 37)
    ,  58 => array('laptopshop', 'Laptop Shop LLC', 'Notebooks / Netbooks', '//laptopshop.cucak.am/', '#009f6a', 'white', 58)
    ,  92 => array('lendarea', 'Complex Service', 'Land areas', '//cucak.am/92', '#932907', 'white', 92)
    , 118 => array('jin', 'Jin.am', 'Electronics', '//jin.cucak.am/', '#9AADB1', 'white', 118)
    , 106 => array('tablet', 'Proline Computers', 'Tablets / PCs', '//proline.cucak.am/', '#4698D6', 'white', 106)
    , 101 => array('nelly', 'Nelly', 'Clothing / Accessories', '//nelly.cucak.am', '#d2006a', 'white', 101)
    , 116 => array('realestate2', 'Ապրանքային Բորսա', 'Real estate', '//cucak.am/116', '#0B74A3', 'white', 116)
    , 111 => array('electronics4', 'Gor', 'Electronics', '//cucak.am/111', '#658415', 'white', 111)
    , 124 => array('melanshop', 'MELANSHOP', 'www.melanshop.com', '//melan.cucak.am/', '#fff', 'black', 124)
    , 127 => array('armspy', 'ArmSpy.ru', 'Electronics', '//armspy.cucak.am', '#68ABDF', 'white', 127)
    , 128 => array('uslaptop', 'US Laptop', 'Notebooks / Netbooks', '//uslaptop.cucak.am', '#68ABDF', 'white', 128)
    , 130 => array('notebookcentre', 'Notebookcentre.am', 'Notebooks / Tablets', '//notebookcentre.cucak.am/', /* '#004247'*/ '#B5E7EF', 'black', 130)
    , 134 => array('inessa', 'Inessa', 'Creative items', '//cucak.am/134', '#bd0611', 'white', 134)
    , 150 => array('luxurycode', 'LuXuRy_CoDe', 'Clothing / Accessories', '//luxurycode.cucak.am/', /* '#004247'*/ '#000000', 'white', 150)
    , 153 => array('sarkis', 'Sargis', 'Car accessories / Devices', '//cucak.am/153', '#667285', 'white', 153)
    , 163 => array('realtime', 'REAL TIME', 'Photography', '//realtime.cucak.am/', '#547857', 'white', 163, 'types' => array('photos'))
    , 168 => array('mgcomp', 'MG Computers', 'Tablets / PCs', '//mgcomp.cucak.am/', '#02B442', 'white', 168)
    , 170 => array('margarita', 'MARGARITA TRAVEL', 'LEVON TOUR', '//cucak.am/170', '#83c326', 'white', 170)
    //, 202 => array('anymode', 'AnyMode', 'DESCRIPTION', '//anymode.cucak.am/', '#83c326', 'white', 202)
    , 215 => array('fanfan', 'FanFan', 'Flowers', '//fanfan.cucak.am/', '#E67B7B', 'white', 215)
    , 221 => array('noberty', 'Noberty', 'handmade', '//noberty.cucak.am/', '#83c326', 'white', 221)
    , 263 => array('led', 'LED Computers', 'Computers / Tablets', '//led.cucak.am/', '#D1D1D1', 'black', 263)
    , 343 => array('aba', 'ABA Products', 'Internet shop', '//aba.cucak.am/', '#4698D6', 'white', 343)
    , 349 => array('scs', 'Smart Cyber Service', 'Computers / Tablets', '//smart.cucak.am/', '#4A7DBC', 'white', 349) 
    , 919 => array('codecomp', 'Code Computers', 'Computers / Tablets', '//codecomp.cucak.am/', '#FFCD00', 'black', 919) 

);

global $registredAgents;
$registredAgents = array(
      '4562.agent.cucak.am' => 4562, 'www.4562.agent.cucak.am' => 4562,
      '7896.agent.cucak.am' => 7896, 'www.7896.agent.cucak.am' => 7896,
);

global $registredAgentsData;
$registredAgentsData = array(
      4562 => (object) array ('id' => 4562, 'name' => 'Tiko', 'registered' => '30.04.2013'),
      7896 => (object) array ('id' => 7896, 'name' => 'Tato', 'registered' => '---'),
);

function author_url($param1 = false, $param2 = false)
{
    if (is_numeric($param1)) {
        $authorId = $param1;
    } elseif (is_numeric($param2)) {
        $authorId = $param2;
    } else {
        $authorId = arg($_GET, 'author', 0);
    }
    
    if (is_string($param1)) {
        $command = $param1;
    } elseif (is_string($param2)) {
        $command = $param2;
    } else {
        $command = '';
    }
    
    if(!($authorId > 0))
        return '';
    
    global $registredSubdomains, $additionalData;
    
    foreach($registredSubdomains as $key => $value)
        if($value == $authorId)
        {
            return "//$key";
        }
    
    return site_url("/$authorId");
}


//function author_url($command = '', $authorId = false)
//{
//    global $authors;
    
//    if($authorId === false && isset($_GET['author']))
//        $authorId = $_GET['author'];
    
//    if(!$authorId)
//        return '';
    
//    foreach($authors as $key => $value)
//        if($value == $authorId)
//        {
//            return $key;
//        }
    
//    return '';
//}


function getAuthorKey($authorId = false)
{
    global $registredSubdomains;
    
    if ($authorId === false)
        $authorId = arg($_GET, 'author', 0);
    
    if (!$authorId > 0)
        return '';
    
    if(isset($registredSubdomains[HTTP_HOST])) {
        if ($authorId == $registredSubdomains[HTTP_HOST]) {
            return HTTP_HOST;
        }
    }

    foreach($registredSubdomains as $key => $value) {
        if($value == $authorId) {
            return $key;
        }
    }
    
    return '';
}

function getAuthorsData() {
    global $wpdb, $additionalData;

    $wp_query	=	"SELECT 
                        post_author AS author,
                        COUNT(Id) * 100 AS `count` 
                    FROM
                        {$wpdb->prefix}posts 
                    WHERE post_type = 'post' AND post_status = 'publish'
                    GROUP BY post_author,
                        post_type";
                    
    $wp_query	=	"SELECT 
                        p.post_author AS author,
                        COUNT(Id) AS `count`, 
                        #COUNT(p.ID) * 100 + SUM(pm.`meta_value`) AS `points`
                        COUNT(p.ID) + SUM(pm.`meta_value`) / 100 AS `points`
                    FROM
                        {$wpdb->prefix}posts p
                        JOIN `{$wpdb->prefix}postmeta` pm ON pm.`post_id` = p.ID AND `meta_key` = '_count-views_all'
                    WHERE p.post_type = 'post' AND p.post_status = 'publish' AND p.post_author != 2
                    GROUP BY p.post_author
                    ORDER BY `points` DESC";


    $ad = $wpdb->get_results($wp_query);
    
    $place = 0;
    
    if(!empty($ad)) {
        foreach($ad as $id => $hh) {
            if (!isset($additionalData[$hh->author]))
                $additionalData[$hh->author] = array();
                //continue;
                
            $place++;
            
            $additionalData[$hh->author]['count'] = $hh->count;
            $additionalData[$hh->author]['points'] = $hh->points;
            $additionalData[$hh->author]['place'] = $place;
        }
    }
    
    //$additionalData[1] = array('count' => 123, 'points' => 345, 'place' => 1);
    //$additionalData[2] = array('count' => 431, 'points' => 945, 'place' => 1);
    //$additionalData[12] = array('count' => 431, 'points' => 945, 'place' => 1);
}

function add_top_menu_item($id, $title = false, $href = false) {
    $authorId = arg($_GET, 'author', 0);

    if(!$authorId > 0) return;
    if($id == 'settings' && $authorId != get_current_user_id()) return;
    if($id == 'photos' && strpos(get_user_meta($authorId, 'photos', true), '{json}') === false) return;
    
    $name = get_user_meta($authorId, 'display_name', true);
    $name = (strlen($name) > 0) ? $name : __('Home');
    
    $authorPage = arg($_GET, 'page', '');

    switch ($authorPage) {
        case 'photos': case 'about': case 'info': case 'contacts':
            break;
        default:
            $authorPage = 'home';
    }
    
    if ($title === false) {
        $title = $name;
    }
    
    $authorKey = getAuthorKey($authorId);
    if ($authorKey) {
        $prefix ="//$authorKey";
    } else {
        $prefix = site_url("/$authorId");
    }
    
    if ($href === false) {
        $href = "$prefix?page=$id";
    }
    
    ?>  <li class="menu-item menu-item-type-custom menu-item-object-custom <?php echo $authorPage == $id ? 'menu-item-active' : '' ?>">
            <a class="author-menu-item <?php echo "author-menu-$id" ?>" href="<?php echo $href ?>"><?php echo $title ?></a>
        </li>
    <?php
}

define('ADMIN_TO', true);

function author_can_edit($adminTo = false) {
    $authorId = arg($_GET, 'author', 0);
    return ($authorId > 0 && $authorId == get_current_user_id()) || ($adminTo && current_user_can( 'manage_options' ));
}

require_once('includes/dynamic-tools.php');
require_once('includes/dynamic-helpers.php');
